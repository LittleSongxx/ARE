<launch>
  <arg name="base_frame" default="sensor"/>
  <arg name="sensor_range" default="20.0"/>
  <arg name="map_resolution" default="0.4"/>

  <!-- 默认的节点密度 -->
  <arg name="node_resolution" default="2.0"/>

  <arg name="enable_terrain" default="true"/>
  <arg name="only_ground_free" default="false"/>

  <node pkg="octomap_server" type="octomap_server_node" name="octomap" output="log" unless="$(arg enable_terrain)">
    <remap from="cloud_in" to="sensor_scan"/>
    <remap from="projected_map" to="grid_map"/>
    <param name="frame_id" value="map"/>
    <param name="base_frame_id" value="$(arg base_frame)"/>
    <param name="resolution" value="$(arg map_resolution)"/>
    <param name="occupancy_min_z" type="double" value="0.0"/>
    <param name="occupancy_max_z" type="double" value="1.2"/>
    <param name="sensor_model/max_range" value="$(arg sensor_range)" />
    <param name="sensor_model/hit" value="1"/>
    <param name="sensor_model/miss" value="0.45"/>
    <param name="sensor_model/max" value="1"/>
    <param name="sensor_model/min" value="0.2"/>
    <param name="publish_free_space" value="true"/>
  </node>

  <include file="$(find ariadne2)/launch/map_handler.launch" if="$(arg enable_terrain)">
    <arg name="sensor_range" value="$(arg sensor_range)" />
    <arg name="map_resolution" value="$(arg map_resolution)" />
    <arg name="only_ground_free" value="$(arg only_ground_free)" />
  </include>

  <node pkg="ariadne2" type="rl_planner.py" name="ariadne2_planner" output="screen" cwd="node">
    <remap from="projected_map" to="grid_map"/>
    <param name="publish_graph" type="bool" value="true"/>
    <param name="node_resolution" value="$(arg node_resolution)"/>

    <!-- 动态分辨率 -->
    <param name="enable_dynamic_resolution" type="bool" value="false"/>
    <param name="min_node_resolution" value="1.2"/>
    <param name="max_node_resolution" value="2.5"/>
    <param name="narrow_threshold" value="3.5"/>

    <!-- 跳跃连接控制（仅动态分辨率时生效） -->
    <param name="jump_search_radius_factor" value="3.0"/>
    <param name="jump_min_distance_factor" value="0.7"/>
    <param name="jump_max_distance_factor" value="2.2"/>

    <!-- 方向性偏置控制（余弦相似度） -->
    <param name="use_directional_bias" type="bool" value="false"/>
    <param name="directional_bias_alpha" value="0.3"/>

    <!-- 增量社区更新控制 -->
    <param name="enable_incremental_community_update" type="bool" value="false"/>
    <param name="incremental_update_threshold_factor" value="2.0"/>

    <!-- 社区可达性检查控制（一定程度避免在墙后面生成社区） -->
    <param name="enable_community_reachability_check" type="bool" value="false"/>

    <!-- 增强碰撞检测开关（false: 单格检测；true: 3×3邻域检测） -->
    <param name="enable_enhanced_collision_check" type="bool" value="false"/>

    <!-- Basic Parameters -->
    <param name="sensor_range" value="$(arg sensor_range)"/>

    <!-- 效用检测范围（sensor_range的倍率） -->
    <param name="utility_range_factor" value="0.5"/>
    <param name="min_utility" type="int" value="3"/>

    <!-- 前沿点降采样因子 -->
    <param name="frontier_downsample_factor" value="3"/>

    <!-- 社区聚类范围 -->
    <param name="frontier_cluster_range" value="20.0"/>

    <param name="map_resolution" value="$(arg map_resolution)"/>
    <param name="global_path_strategy" value="tsp"/>
    <param name="hard_update_threshold" value="5.0"/>
    <param name="replanning_frequency" value="1"/>
    <param name="waypoint_threshold" value="4"/>
  </node>

  <node pkg="tf" type="static_transform_publisher" name="link_broadcaster" args="0 0 0 0 0 0 1 vehicle base_link 100" />

  <node launch-prefix="nice" pkg="rviz" type="rviz" name="rl_rviz" args="-d $(find ariadne2)/rviz/ARiADNE2.rviz" respawn="true"/>
</launch>
